name: Create ELK Detection Rule via GitHub Action

on:
  workflow_dispatch:
    inputs:
      kibana_url:
        description: 'Kibana URL (e.g., http://104.197.3.125:5601)'
        required: true
      username:
        description: 'Kibana Username'
        required: true
      rule_id:
        description: 'Rule ID'
        default: 'powershell-execution-rule'
      rule_name:
        description: 'Rule Name'
        default: 'Suspicious PowerShell Execution'
      query:
        description: 'KQL/Lucene Query'
        default: 'event_id:1 AND process.name:PowerShell.exe'

jobs:
  create-rule:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Generate Rule JSON via Python
        run: |
          python generate_rule_body.py <<EOF
          ${{ github.event.inputs.rule_id }}
          ${{ github.event.inputs.rule_name }}
          Detects suspicious PowerShell executions from Sysmon logs
          ${{ github.event.inputs.query }}
          winlogbeat-*
          70
          medium
          windows,powershell,execution
          5m
          now-5m
          true
          EOF

      - name: Create Detection Rule in Elastic SIEM
        shell: pwsh
        env:
          KIBANA_URL: ${{ github.event.inputs.kibana_url }}
          USERNAME: ${{ github.event.inputs.username }}
          PASSWORD: ${{ secrets.KIBANA_PASSWORD }}   # store securely in GitHub Secrets
        run: |
          $authHeader = "Basic " + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$env:USERNAME`:$env:PASSWORD"))
          $headers = @{
            "Content-Type" = "application/json"
            "kbn-xsrf"      = "true"
            "Authorization" = $authHeader
          }

          $body = Get-Content rule.json -Raw
          Write-Host "Sending Detection Rule to Kibana..."
          Invoke-RestMethod -Method POST -Uri "$env:KIBANA_URL/api/detection_engine/rules" -Headers $headers -Body $body
          Write-Host "âœ… Detection Rule Created Successfully!"
